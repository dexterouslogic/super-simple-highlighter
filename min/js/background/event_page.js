var _eventPage={init:function(){"use strict";chrome.runtime.onInstalled.addListener(_eventPage.onRuntimeInstalled),chrome.runtime.onStartup.addListener(_eventPage.onRuntimeStartup),chrome.runtime.onMessage.addListener(_eventPage.onRuntimeMessage),chrome.webNavigation.onCompleted.addListener(_eventPage.onWebNavigationCompleted),chrome.storage.onChanged.addListener(_eventPage.onStorageChanged),chrome.contextMenus.onClicked.addListener(_contextMenus.onClicked),chrome.commands.onCommand.addListener(_eventPage.onCommandsCommand)},onRuntimeInstalled:function(details){"use strict";_database.putDesignDocuments(function(){_database.viewCleanup()}),_contextMenus.recreateMenu()},onRuntimeStartup:function(){"use strict";_database.getMatchSums(function(err,rows){rows&&rows.forEach(function(row){0===row.value&&_database.removeDocuments(row.key)}),_database.compact()})},onWebNavigationCompleted:function(details){"use strict";if(0===details.frameId){var match=_database.buildMatchString(details.url);_database.getDocuments(match,function(err,docs){err||0!==docs.length&&_tabs.executeAllScripts(details.tabId,!1,function(){var sum=_tabs.replayDocuments(details.tabId,docs,function(doc){"create"===doc.verb&&_eventPage.setPageActionStatus(details.tabId,!0)});sum>0&&chrome.pageAction.show(details.tabId)})})}},setPageActionStatus:function(tabId,not_in_dom){"use strict";chrome.pageAction.setTitle({tabId:tabId,title:chrome.i18n.getMessage(not_in_dom?"page_action_title_not_in_dom":"page_action_default_title")}),chrome.pageAction.setIcon({tabId:tabId,path:{19:not_in_dom?"static/images/popup/19_warning.png":"static/images/19.png",38:not_in_dom?"static/images/popup/38_warning.png":"static/images/38.png"}})},onRuntimeMessage:function(message,sender){"use strict";switch(message.id){case"on_mouse_enter_highlight":_contextMenus.setHoveredHighlightId(message.highlightId);break;case"on_mouse_leave_highlight":_contextMenus.setHoveredHighlightId(null);break;default:throw"unhandled message: sender="+sender+", id="+message.id}},onTabActivated:function(){"use strict";_contextMenus.setHoveredHighlightId(null)},onStorageChanged:function(changes,namespace){"use strict";"sync"===namespace&&changes.highlightDefinitions&&_contextMenus.recreateMenu()},onCommandsCommand:function(command){"use strict";var re=new RegExp("^apply_highlight\\.(\\d+)$"),match=re.exec(command);if(!match||2!==match.length)throw"unknown command "+command;var index=parseInt(match[1]);_storage.highlightDefinitions.getAll(function(items){if(items&&items.highlightDefinitions&&!(items.highlightDefinitions.length<=index)){var hd=items.highlightDefinitions[index];chrome.tabs.query({active:!0,currentWindow:!0},function(tabs){if(tabs){var activeTab=tabs[0],match=_database.buildMatchString(activeTab.url);match&&_tabs.sendGetSelectionRangeMessage(activeTab.id,function(xpathRange){if(xpathRange)if(xpathRange.collapsed){var documentId=_contextMenus.getHoveredHighlightId();documentId&&_eventPage.updateHighlight(activeTab.id,documentId,hd.className)}else _tabs.sendGetRangeTextMessage(activeTab.id,xpathRange,function(selectionText){selectionText&&(_eventPage.createHighlight(activeTab.id,xpathRange,_database.buildMatchString(activeTab.url),selectionText,hd.className),_storage.getUnselectAfterHighlight(function(unselectAfterHighlight){unselectAfterHighlight&&_eventPage.selectHighlightText(activeTab.id)}))})})}})}})},createHighlight:function(tabId,xpathRange,match,selectionText,className){"use strict";xpathRange.collapsed||(delete xpathRange.collapsed,_database.postCreateDocument(match,xpathRange,className,selectionText,function(err,response){if(!err)try{_tabs.sendCreateHighlightMessage(tabId,xpathRange,className,response.id,function(is_created){is_created?chrome.pageAction.show(tabId):_database.removeDocument(response.id,response.rev)})}catch(e){_database.removeDocument(response.id,response.rev)}}))},updateHighlight:function(tabId,documentId,className){"use strict";_database.updateCreateDocument(documentId,className,function(err,response){response&&response.ok&&_tabs.sendUpdateHighlightMessage(tabId,documentId,className,function(is_updated){})})},deleteHighlight:function(tabId,documentId,callback){"use strict";_eventPage.isHighlightInDOM(tabId,documentId,function(inDOM){function _resultCallback(err,response){response&&response.ok&&(inDOM&&_tabs.sendDeleteHighlightMessage(tabId,documentId),chrome.tabs.get(tabId,function(tab){var match=_database.buildMatchString(tab.url);_database.getMatchSum(match,function(err,sum){!err&&0>=sum&&chrome.pageAction.hide(tabId)})})),callback&&callback(err,response)}inDOM?_database.postDeleteDocument(documentId,_resultCallback):_database.getDocument(documentId,function(err,doc){return err?void(callback&&callback(err,null)):void _database.removeDocument(doc._id,doc._rev,_resultCallback)})})},deleteHighlights:function(tabId,match){"use strict";_database.removeDocuments(match,function(err,response){err||(chrome.pageAction.hide(tabId),response.forEach(function(r){r.ok&&_tabs.sendDeleteHighlightMessage(tabId,r.id)}))})},selectHighlightText:function(tabId,documentId,responseCallback){"use strict";_tabs.sendSelectHighlightTextMessage(tabId,documentId,responseCallback)},copyHighlightText:function(documentId){"use strict";_database.getDocument(documentId,function(err,doc){if(doc&&doc.text){var div=document.createElement("div");div.contentEditable=!0,document.body.appendChild(div),div.innerHTML=doc.text,div.unselectable="off",div.focus(),document.execCommand("SelectAll"),document.execCommand("Copy",!1,null),document.body.removeChild(div)}})},speakHighlightText:function(documentId,options){"use strict";_database.getDocument(documentId,function(err,doc){doc&&doc.text&&(options?chrome.tts.speak(doc.text,options):chrome.storage.sync.get({ttsSpeakOptions:null},function(items){chrome.runtime.lastError||chrome.tts.speak(doc.text,items.ttsSpeakOptions)}))})},isHighlightInDOM:function(tabId,documentId,responseCallback){"use strict";_tabs.sendIsHighlightInDOMMessage(tabId,documentId,responseCallback)},scrollTo:function(tabId,documentId,responseCallback){"use strict";_tabs.sendScrollToMessage(tabId,documentId,responseCallback)}};_eventPage.init();